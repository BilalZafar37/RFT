<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="/static/img/apple-icon.png">
  
  <link rel="icon" type="image/png" href="/static/img/favicon.png">
  <title>
    RFT
  </title>
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
  <!-- Nucleo Icons -->
  <link href="/static/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/static/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <!-- CSS Files -->
  <link id="pagestyle" href="/static/css/material-dashboard.css?v=3.1.0" rel="stylesheet" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

</head>

<style>
  .layout {
  display: flex;
  align-items: flex-start; /* keep both at top */
  height: 100vh;           /* optional, full-height layout */
  overflow: hidden;        /* if you want scroll inside page-content only */
  }

  /* style the sidebar host itself */
  my-sidebar {
    flex: 0 0 250px;         /* fixed 250px wide */
    height: 100%;            /* match container height if you like */
    box-shadow: 2px 0 6px rgba(0,0,0,0.1);
    background: #fff;
    overflow-y: auto;        /* scroll if sidebar content is tall */
  }


  /* the main area takes the rest of the space */
  .page-content {
    flex: 1 1 auto;
    padding: 1rem;
    overflow-y: auto;        /* scroll inside main */
  }

  .chart-container1 {
  flex: 1;
  position: relative;
  height: 400px;   /* pick whatever height you like */
  }
  .chart-container {
  flex: 1;
  position: relative;
  height: 300px;   /* pick whatever height you like */
  }
  .chart-container canvas {
    /* force the canvas to fill the parent */
    width: 100% !important;
    height: 100% !important;
  }
  /* For WebKit browsers (Chrome, Safari, Edge) */
  .scroll-container::-webkit-scrollbar {
    width: 10px;
  }

  .scroll-container::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .scroll-container::-webkit-scrollbar-thumb {
    background-color: #c1c1c1;
    border-radius: 5px;
    border: 2px solid #f1f1f1;
  }

  .scroll-container::-webkit-scrollbar-thumb:hover {
    background-color: #a8a8a8;
  }

  /* For Firefox */
  .scroll-container {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
  }

  .fixed-height-card {
    height: 350px;
    display: flex;
    flex-direction: column;
  }

  .scrollable-card-body {
    flex: 1 1 auto;
    overflow: auto !important;;
  }

  .bg-gradient-primary {
    background-image: linear-gradient(195deg, #4054ec 0%, #D81B60 100%);
  }
  .dropdown-container {
  display: none;
  /* background-color: #262626; */
  padding-left: 8px;
  }
  ::-webkit-scrollbar {
    display: none;
  }
  .dropdown-btn {
  padding: 6px 8px 6px 16px;
  text-decoration: none;
  font-size: 20px;
  color: #818181;
  display: block;
  border: none;
  background: none;
  width:100%;
  text-align: left;
  cursor: pointer;
  outline: none;
  }
  .hov:hover{
    
    display: flex;
    width: 169px;
    border: none;
    border-radius: 5px;
    background-image: linear-gradient(195deg, #4054ec 0%, #D81B60 100%);
  }
  .numbadge {
  --bs-badge-padding-x: 0.5em;
  --bs-badge-padding-y: 0.5em;
  --bs-badge-font-size: 0.75em;
  --bs-badge-font-weight: 700;
  --bs-badge-color: #fff;
  --bs-badge-border-radius: 10rem;
  display: inline-block;
  padding: var(--bs-badge-padding-y) var(--bs-badge-padding-x);
  font-size: var(--bs-badge-font-size);
  font-weight: var(--bs-badge-font-weight);
  line-height: 1;
  color: var(--bs-badge-color);
  text-align: center;
  white-space: nowrap;
  vertical-align: baseline;
  border-radius: var(--bs-badge-border-radius);
  }
  /* Target the select2 container */
.select2-container {
    max-width: 607.321px !important;
    min-width: 190px !important;
    width: auto !important;
}

/* Ensure the dropdown itself also follows the same width */
.select2-dropdown {
    max-width: 607.321px !important;
    min-width: 190px !important;
    width: auto !important;
}

/* Style the inner text field where the selection appears */
.select2-selection {
    max-width: 607.321px !important;
    min-width: 190px !important;
    width: auto !important;
}

</style>

<body class="g-sidenav-show layout" style="background: radial-gradient(#da4646, #325fff);">
  <!-- SERCHABLE DROPDOWNS -->
  <!-- Include jQuery and Select2 JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script>
    $(document).ready(function () {
      $("#lt_brands, #cost_categories, #cost_brands, #po_list, #ful_brands, #dtc_brands, #wh_brands, #shp_brands").select2({
        multiple: true,
        allow_clear:true,
      });
    });
  </script>
  
  <!-- 1) Define a template holding your sidebar HTML -->
  <template id="sidebar-template">
    {% include 'sidebar2.html' %}
  </template>
  
  <!-- 2) Use only the custom element in your body -->
  <my-sidebar class="{% if current_user.theme=='dark' %}dark-version{% endif %}" style="max-width: max-content;"></my-sidebar>
  

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg page-content">

    <!-- Navbar contains username -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li style="color: white;" class="breadcrumb-item text-sm active" aria-current="page">Home</li>
          </ol>
          <h6 style="color: white;" class="font-weight-bolder mb-0">Dashboard</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group input-group-outline">
              <label aria-placeholder="Type here" class="form-label"></label>
              <input style="color: white;" placeholder="Type here" type="text" class="form-control">
            </div>
          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="#" class="nav-link text-body p-0">
                <i style="color: white;" class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a href="/login" class="nav-link text-body font-weight-bold px-0">
                <i style="color: white;" class="fa fa-user me-sm-1"></i>
                <span class="d-sm-inline d-none" style="color: white;">{{session['username']}}</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->

    <form class="filter-form" method="post" action="{{ url_for('dashboard.dashboard') }}">
      <div class="container-fluid py-4">
        <div class="row">
          <!-- DTC CONTAINERS -->
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card fixed-height-card">
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-dark shadow-primary border-radius-lg pt-4 pb-3">
                  <h6 class="bg-gradient-primary text-white text-capitalize text-center ps-3" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">Monthly</h6>
                </div>
              </div>
              <div class="card-header p-3 pt-2">
                <h5 class="text-center"><i class="material-icons opacity-10" style="color: gold;">paid</i>DTC Containers</h5>
              </div>
              <div class="card-body scrollable-card-body" style="padding-top: 0px;">
                <div class="pt-1">
                  <!-- <form class="filter-form" method="POST" action="/"> -->
                    <!-- <label for="brand1">Filter by Brand:</label> -->
                    <input type="hidden" value="t1" name="t1"> 
                    <select style="width: 190px;" id="dtc_brands" name="brand_ytd[]" multiple>
                      <option value="" selected disabled>All</option>
                      <option value="ALL HAP">ALL HAP</option>
                      {% for brand in brands_list %}
                        {% if brand in session['user_brand_access'] or session['role'] == 'admin' %}
                          <option value="{{ brand }}" {% if brand in selected_brand_t1  %}selected{% endif %}>{{ brand }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                    <button class="badge badge-sm bg-gradient-info" style=" border: 1px solid black; width: 66px;" type="submit">Brand</button>
                    
                    <select style="width: 190px;" name="created_month_ytd" id="month1"> 
                      <option value="All">All months</option>
                      {% for month in all_created_months %}
                        <option value="{{ month }}" {% if selected_created_month == month %}selected{% endif %}>{{ month }}</option>
                      {% endfor %}
                    </select>
                    <button class="badge badge-sm bg-gradient-info" style=" border: 1px solid black;" type="submit">Month</button>
                  <!-- </form> -->
                  <hr class="dark horizontal">
                  <table>
                    <tbody>
                      {% for rec in dtc_container_report %}
                        <tr>
                          <td>{{ rec.stage }}</td>
                          <td>{{ rec.count }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- WAREHOUSE CONATINERS-->
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card fixed-height-card">
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-dark shadow-primary border-radius-lg pt-4 pb-3">
                  <h6 class="bg-gradient-primary text-white text-capitalize text-center ps-3" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">Monthly</h6>
                </div>
              </div>
              <div class="card-header p-3 pt-2">
                <h5 class="text-center"><i class="material-icons opacity-10" style="color: gold;">paid</i>Warehouse Containers</h5>
              </div>
              <div class="card-body scrollable-card-body" style="padding-top: 0px;">
                <div class="pt-1">
                  <!-- <form class="filter-form" method="POST" action="/"> -->
                    <!-- <label for="brand1">Filter by Brand:</label> -->
                    <input type="hidden" value="t1" name="t1"> 
                    <select style="width: 190px;" id="wh_brands" name="brand_ytd[]" multiple>
                      <option value="" selected disabled>All</option>
                      <option value="ALL HAP">ALL HAP</option>
                      {% for brand in brands_list %}
                        {% if brand in session['user_brand_access'] or session['role'] == 'admin' %}
                          <option value="{{ brand }}" {% if brand in selected_brand_t1  %}selected{% endif %}>{{ brand }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                    <button class="badge badge-sm bg-gradient-info" style=" border: 1px solid black; width: 66px;" type="submit">Brand</button>
                    
                    <select style="width: 190px;" name="created_month_ytd" id="month1"> 
                      <option value="All">All months</option>
                      {% for month in all_created_months %}
                        <option value="{{ month }}" {% if selected_created_month == month %}selected{% endif %}>{{ month }}</option>
                      {% endfor %}
                    </select>
                    <button class="badge badge-sm bg-gradient-info" style=" border: 1px solid black;" type="submit">Month</button>
                  <!-- </form> -->
                  <hr class="dark horizontal">
                  <table>
                    <tbody>
                      {% for rec in wh_container_report %}
                        <tr>
                          <td>{{ rec.stage }}</td>
                          <td>{{ rec.count }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Shipment Statuses -->
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card fixed-height-card">
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-dark shadow-primary border-radius-lg pt-4 pb-3">
                  <h6 class="bg-gradient-primary text-white text-capitalize text-center ps-3" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">Monthly</h6>
                </div>
              </div>
              <div class="card-header p-3 pt-2">
                <h5 class="text-center"><i class="material-icons opacity-10" style="color: gold;">paid</i>Shipment Statuses</h5>
              </div>
              <div class="card-body scrollable-card-body" style="padding-top: 0px;">
                <div class="pt-1">
                  <!-- <form class="filter-form" method="POST" action="/"> -->
                    <!-- <label for="brand1">Filter by Brand:</label> -->
                    <input type="hidden" value="t1" name="t1"> 
                    <select style="width: 190px;" id="shp_brands" name="brand_ytd[]" multiple>
                      <option value="" selected disabled>All</option>
                      <option value="ALL HAP">ALL HAP</option>
                      {% for brand in brands_list %}
                        {% if brand in session['user_brand_access'] or session['role'] == 'admin' %}
                          <option value="{{ brand }}" {% if brand in selected_brand_t1  %}selected{% endif %}>{{ brand }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                    <button class="badge badge-sm bg-gradient-info" style=" border: 1px solid black; width: 66px;" type="submit">Brand</button>
                    
                    <select style="width: 190px;" name="created_month_ytd" id="month1"> 
                      <option value="All">All months</option>
                      {% for month in all_created_months %}
                        <option value="{{ month }}" {% if selected_created_month == month %}selected{% endif %}>{{ month }}</option>
                      {% endfor %}
                    </select>
                    <button class="badge badge-sm bg-gradient-info" style=" border: 1px solid black;" type="submit">Month</button>
                  <!-- </form> -->
                  <hr class="dark horizontal">
                  <table>
                    <tbody>
                      {% for rec in shipment_status_report %}
                        <tr>
                          <td>{{ rec.status }}</td>
                          <td>{{ rec.count }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Upcomming ETAs  -->
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card fixed-height-card">
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-dark shadow-primary border-radius-lg pt-4 pb-3">
                  <h6 class="bg-gradient-primary text-white text-capitalize text-center ps-3" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">Monthly</h6>
                </div>
              </div>
              <div class="card-header p-3 pt-2">
                <h5 class="text-center"><i class="material-icons opacity-10" style="color: gold;">paid</i>Upcomming ETAs</h5>
              </div>
              <div class="card-body scrollable-card-body" style="padding-top: 0px;">
                <div class="pt-1">
                  
                  <hr class="dark horizontal">
                  <table>
                    <thead>
                      {% if upcoming_eta %}
                      <tr>
                        <th>Shipment #</th>
                        <th>No of containers</th>
                        <th>ETA Dest.</th>  
                        <th>Origin Port</th>
                        <th>Destination Port</th>
                      </tr>
                      {% endif %}
                    </thead>
                    <tbody>
                      {% if not upcoming_eta %}
                        <tr><td colspan="4" class="text-center">No arrivals in the next week</td></tr>
                      {% else %}
                        {% for rec in upcoming_eta %}
                          <tr>
                            <td>{{ rec.shipment }}</td>
                            <td>{{ rec.containers_num }}</td>
                            <td>{{ rec.eta.strftime("%Y-%m-%d") }}</td>
                            <td>{{ rec.origin_port }}</td>
                            <td>{{ rec.dest_country }}</td>
                          </tr>
                        {% endfor %}
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        

        <div class="row mt-4">
          <div class="col-lg-6 mt-4 mb-3">
            <div class="card z-index-2 "> 
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
                <div class="bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1" style="display:flex; gap:2rem;">
                  <div class="chart-container">
                    <canvas id="costPie"></canvas>
                    <div id="cost-stats" style="margin-bottom:1rem; text-align:center;">
                      <span id="avgcost" style="font-size:1.25rem; font-weight:bold; color: white;">
                        Average Expense per Shipment: {{ avg_per_shipment }} USD
                      </span>
                      <span id="avgcost" style="font-size:1.25rem; font-weight:bold; color: white;">
                        Average Expense per Container: {{ avg_per_container  }} USD
                      </span>
                      <span id="avgcost" style="font-size:1.25rem; font-weight:bold; color: white;">
                        Average Expense per Piece: {{ avg_per_article  }} USD
                      </span>
                    </div>
                  </div>
                  <div class="chart-container1">
                    <canvas id="costChart"></canvas>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <label for="cost_brands">Brand:</label>
                <select name="cost_brands[]" id="cost_brands" multiple>
                  <option value="" selected disabled>All</option>
                  <option value="ALL HAP">ALL HAP</option>
                  {% for brand in all_cost_brands %}
                    {% if brand in session['user_brand_access'] or session['role'] == 'admin'%}
                        <option value="{{ brand }}" {% if brand in sel_cost_brands %}selected{% endif %}>{{ brand }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
                
                <label for="cost_categories">Categories:</label>
                <select name="cost_categories[]" id="cost_categories" multiple>
                  <option value="" selected disabled>All</option>
                  <option value="ALL HAP">ALL HAP</option>
                  {% for cats in all_cost_cats %}
                    {% if brand in session['user_brand_access'] or session['role'] == 'admin'%}
                        <option value="{{ cats }}" {% if cats in sel_cost_cats %}selected{% endif %}>{{ brand }}</option>
                    {% endif %}
                  {% endfor %}
                </select>

                <select class="form-control-lg" style="width: 190px;" name="cost_months" id="month1"> 
                  <option value="All">All months</option>
                  {% for month in all_cost_months %}
                    <option value="{{ month }}" {% if sel_cost_months == month %}selected{% endif %}>{{ month }}</option>
                    <!-- |datetimeformat -->
                  {% endfor %}
                </select>
                <button class="btn bg-gradient-info form-label"  type="submit">Filter</button>
                <button class="btn bg-gradient-dark" id="resetCostChart" style="margin:1em;" type="button">Back to Brands</button>
              </div>
            </div>
          </div>

          <div class="col-lg-6 mt-4 mb-3">
            <div class="card z-index-2 "> 
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
                <div class="bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1" style="display:flex; gap:2rem;">
                  <div class="chart-container1">
                    <canvas id="ltChart"></canvas>
                  </div>
                  <div class="chart-container">
                    <button class="btn bg-gradient-dark" id="resetChart" style="margin:1em;" type="button">← Back to Brands</button>
                    <div id="leadtime-stats" style="margin-bottom:1rem; text-align:center;">
                      <span id="avgLeadTime" style="font-size:1.25rem; font-weight:bold; color: white;">
                        Average Lead Time: - days
                      </span>
                    </div>
                    <canvas id="ltPie"></canvas>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <!-- Filter for chart_1_brand_wise  -->
                <label for="lt_brands">Brand:</label>
                <select name="lt_brands[]" id="lt_brands" multiple>
                  <option value="" selected disabled>All</option>
                  <option value="ALL HAP">ALL HAP</option>
                  {% for brand in all_lt_brands %}
                    {% if brand in session['user_brand_access'] or session['role'] == 'admin'%}
                        <option value="{{ brand }}" {% if brand in sel_lt_brands %}selected{% endif %}>{{ brand }}</option>
                    {% endif %}
                  {% endfor %}
                </select>

                <select class="form-control-lg" style="width: 190px;" name="lt_months" id="month1"> 
                  <option value="All">All months</option>
                  {% for month in all_lt_months %}
                    <option value="{{ month }}" {% if sel_lt_months == month %}selected{% endif %}>{{ month }}</option>
                    <!-- |datetimeformat -->
                  {% endfor %}
                </select>

                <label>Shipment #:</label>
                <input name="filter_shipment" value="{{ selected_ship }}">

                <label>PO #:</label>
                <input name="filter_po" value="{{ selected_po }}">

                <label>Show limit</label>
                <input type="number" name="lt_limit" value="{{ shipment_limit }}" min="1">

                <button class="btn bg-gradient-info form-label"  type="submit">Filter</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ROW 2 -->
        <div class="row mt-4">
          <div class="col-lg-12 mt-4 mb-3">
            <div class="card z-index-2 "> 
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
                <div class="bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1" style="display:flex; gap:2rem;">
                  <div class="chart-container">
                    <canvas id="fulfillBrandChart" style="height:300px"></canvas>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <label>PO Number:</label>
                <select name="po_list[]" id="po_list">
                  {% for po in all_pos %}
                    <option value="{{po}}"
                      {% if po in sel_pos %}selected{% endif %}>
                      {{po}}
                    </option>
                  {% endfor %}
                </select>

                <label>Brands:</label>
                <select name="ful_brands[]" id="ful_brands" multiple>
                  {% for b in all_brands %}
                    <option value="{{b}}" {% if b in sel_brands %}selected{% endif %}>{{b}}</option>
                  {% endfor %}
                </select>
                
                <button class="btn bg-gradient-info form-label"  type="submit">Filter</button>
                <button class="btn bg-gradient-dark form-label" id="resetFulfill">Back to Brands</button>
              </div>
            </div>
          </div>
        </div>
    </form>
  </main>

  <!--   Core JS Files   -->
  <script src="/static/js/core/popper.min.js"></script>
  <script src="/static/js/core/bootstrap.min.js"></script>
  <script src="/static/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="/static/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="/static/js/generalScripts.js"></script>
  <script src="/static/js/plugins/chartjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- Leadtime chart -->
  <script>
    const intervals = JSON.parse('{{ lt_intervals_data | tojson }}');
    console.log(intervals)
    const brandData      = JSON.parse('{{ lt_lead_data  | tojson }}');
    console.log(brandData)
    const brands = brandData.map(d => d.brand);
    const palette = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#66FF66'];

    // Helper to build datasets from any data array
    function buildDatasets(dataArr) {
      return intervals.map((cfg,i) => ({
        label: cfg.name,
        data:  dataArr.map(d => d[cfg.name]||0),
        backgroundColor: palette[i % palette.length],
        borderColor:     palette[i % palette.length],
        borderWidth: 1
      }));
    }

    // compute each brand's total lead time
    const totals = brandData.map(d => 
      intervals.reduce((sum, cfg) => sum + (d[cfg.name]||0), 0)
    );

    // compute the overall average
    const avg = totals.length
      ? totals.reduce((a,b)=>a+b,0) / totals.length
      : 0;
    document.getElementById('avgLeadTime').textContent =
      `Average Lead Time: ${avg.toFixed(1)} days`;

    // plugin 
    Chart.register(ChartDataLabels);

    // text white by default
    Chart.defaults.color = '#fff';
    Chart.defaults.borderColor = '#fff';

    const ctx = document.getElementById('ltChart').getContext('2d');
    const ltChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels:   brands,
        datasets: buildDatasets(brandData)
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: { enabled: true },
          legend:  { position: 'bottom', labels:{ color:'#fff' } },
          datalabels: {
            color:'white',
            formatter: v => v.toFixed(0),
            font: { weight:'bold', size:12 },
            anchor:'center', align:'center', clamp:true, clip:true
          }
        },
        scales: { x:{ stacked:true, beginAtZero:true, ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,0.2)'}},
                  y:{ stacked:true, ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,0.2)'}}},
  
        // Drill‐down on click
        onClick: (evt, elems) => {
          if (!elems.length) return;
          const idx   = elems[0].index;
          const brand = ltChart.data.labels[idx];
  
          // filters
          const monthSelect = document.querySelector('select[name="lt_months"]');
          const selMonths = monthSelect.value
            ? [ monthSelect.value ]
            : [];
  
          const limit  = document.querySelector('input[name="lt_limit"]').value || 10;
          const shipF  = document.querySelector('input[name="filter_shipment"]').value.trim();
          const poF    = document.querySelector('input[name="filter_po"]').value.trim();
          
          const params = new URLSearchParams();
          params.set('brand', brand);
          // selBrands.forEach(b=>params.append('brands', b));
          selMonths.forEach(m=>params.append('months', m));
          params.set('lt_limit', limit);
          if (shipF) params.set('filter_shipment', shipF);
          if (poF)   params.set('filter_po', poF);
          console.log(params.toString())
          // fetch shipment‐level data
          fetch(`/dashboard/leadtime/drilldown?${params}`)
            .then(r=>r.json())
            .then(json => {
              ltChart.data.labels   = json.labels;
              ltChart.data.datasets = json.datasets;
              ltChart.update();
            })
            .catch(console.error);
        }
      }
    });

    // pie chart of total lead time by brand
    new Chart(document.getElementById('ltPie'), {
      type: 'pie',
      data: {
        labels: brands,
        datasets: [{
          label: 'Total Lead Time',
          data: totals,
          backgroundColor: palette,
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: false,
          datalabels: {
            formatter: (v, ctx) => {
              const pct = v / totals.reduce((a,b)=>a+b,0) * 100;
              return `${ctx.chart.data.labels[ctx.dataIndex]}\n${v.toFixed(0)}d\n(${pct.toFixed(1)}%)`;
            },
            color: '#fff',
            font: { size: 11, weight:'bold' }
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // resets the top‐level view 
    document.getElementById('resetChart').addEventListener('click', () => {
      ltChart.data.labels   = brands;
      ltChart.data.datasets = buildDatasets(brandData);
      ltChart.update();
    });

  </script>

  <!-- Cost chart and pie chart -->
  <script>
    // 1) Data from the server
    const costData    = JSON.parse('{{ cost_data     | tojson }}');
    const costLabels  = costData.map(d => d.brand);
    const costMonths  = JSON.parse('{{ all_cost_months | tojson }}');
    const costCats    = JSON.parse('{{ all_cost_cats   | tojson }}');

    // 2) Which fields to plot
    const costFields  = [
      "FreightCost","SaberSADDAD","CustomDuties",
      "DemurrageCharges","Penalties","OtherCharges",
      "YardCharges","DO_Port_Charges",
      "ClearanceTransportCharges",
      "InspectionCharges","MAWANICharges"
    ];
    const fieldLabels = costFields.map(f =>
      f.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase())
    );



    function buildCostDatasets(dataArr) {
      return costFields.map((fld,i) => ({
        label:           fieldLabels[i],
        data:            dataArr.map(d => d[fld] || 0),
        backgroundColor: palette[i % palette.length],
        borderColor:     palette[i % palette.length],
        borderWidth:     1
      }));
    }

    // 5) Register plugins & defaults
    Chart.register(ChartDataLabels);
    Chart.defaults.color       = '#fff';
    Chart.defaults.borderColor = '#fff';

    // ─── The main (bar) chart ─────────────────────────────
    const costCtx   = document.getElementById('costChart').getContext('2d');
    const costChart = new Chart(costCtx, {
      type: 'bar',
      data: {
        labels:   costLabels,
        datasets: buildCostDatasets(costData)
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked:true, beginAtZero:true, ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.2)'} },
          y: { stacked:true,                    ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.2)'} }
        },
        plugins: {
          legend:    { position:'bottom', labels:{color:'#fff'} },
          datalabels:{ color:'white', font:{weight:'bold',size:12}, anchor:'center',align:'center',clamp:true,clip:true }
        },
        onClick: (evt, elems) => {
          if (!elems.length) return;
          const idx   = elems[0].index;
          const brand = costChart.data.labels[idx];
          fetch(`/dashboard/cost/drilldown?brand=${encodeURIComponent(brand)}`)
            .then(r=>r.json())
            .then(json=>{
              costChart.data.labels   = json.labels;
              costChart.data.datasets = json.datasets;
              costChart.update();
            })
            .catch(console.error);
        }
      }
    });

    // ─── The pie chart ─────────────────────────────────────
    const expenseTotals = costData.map(d => d.total_expense);
    const pieCtx         = document.getElementById('costPie').getContext('2d');
    const pieChart       = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: costLabels,
        datasets: [{
          label:           'Total Expense',
          data:            expenseTotals,
          backgroundColor: palette,
          borderColor:     '#fff',
          borderWidth:     1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: false,
          datalabels: {
            formatter: (v, ctx) => {
              const total = expenseTotals.reduce((a,b)=>a+b,0) || 1;
              const pct   = v/total*100;
              return [
                ctx.chart.data.labels[ctx.dataIndex],
                v.toFixed(0),
                `(${pct.toFixed(1)}%)`
              ].join('\n');
            },
            color:'#fff',
            font:{size:11,weight:'bold'}
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // ─── Reset button: back to brand view ─────────────────
    document.getElementById('resetCostChart')
      .addEventListener('click', () => {
        // reset bar chart
        costChart.data.labels   = costLabels;
        costChart.data.datasets = buildCostDatasets(costData);
        costChart.update();
      });
  </script>

  <!-- Fulfillment chart -->
  <script>
    // brand‐level data
    const brandData2  = JSON.parse('{{ brand_data | tojson }}');
    const brands2     = brandData2.map(d=>d.brand);
    const deliveredB = brandData2.map(d=>d.delivered_pct);
    const intransitB = brandData2.map(d=>d.intransit_pct);
    const openB = brandData2.map(d=>d.open_pct);
  
    Chart.defaults.color       = '#fff';
    Chart.defaults.borderColor = '#fff';
  
    // draw brand‐level
    const bctx = document.getElementById('fulfillBrandChart').getContext('2d');
    const brandChart = new Chart(bctx, {
      type: 'bar',
      data: {
        labels: brands2,
        datasets: [
          { label:'Delivered ',  data:deliveredB, backgroundColor:'#4CAF50' },
          { label:'In-Transit ', data:intransitB, backgroundColor:'#2196F3' },
          { label:'Open Qty ',  data:openB, backgroundColor:'#03120E' }
        ]
      },
      options: {
        indexAxis: 'y', responsive:true, maintainAspectRatio:false,
        scales:{ x:{ stacked:true, max:100, ticks:{callback:v=>v+'%'}}, y:{stacked:true} },
        onClick:(evt, elems)=>{
          if(!elems.length) return;
          const idx   = elems[0].index;
          const brand = brands2[idx];
          // fire drilldown
          fetch(`/dashboard/fulfillment/drilldown?brand=${encodeURIComponent(brand)}`)
            .then(r=>r.json()).then(json=>{
              poChart.data.labels   = json.labels;
              poChart.data.datasets = json.datasets;
              poChart.update();
            });
        }
      }
    });
  
    // prepare PO chart (empty for now)
    const pctx = document.getElementById('fulfillPOChart').getContext('2d');
    const poChart = new Chart(pctx, {
      type: 'bar',
      data: { labels:[], datasets:[] },
      options: {
        indexAxis: 'y', responsive:true, maintainAspectRatio:false,
        scales:{ x:{stacked:true, max:100, ticks:{callback:v=>v+'%'}}, y:{stacked:true}}
      }
    });
  
    // reset button
    document.getElementById('resetFulfill')
      .addEventListener('click',()=>{
        brandChart.data.labels   = brands;
        brandChart.data.datasets = brandChart.data.datasets.map((ds,i)=>(i===0
           ? {label:'Delivered ', data:deliveredB, backgroundColor:'#4CAF50'}
           : {label:'In-Transit ',data:intransitB,backgroundColor:'#2196F3'}
        ));
        brandChart.update();
      });
  </script>
  
  <!-- script to make shadow dom and add side bar and some style sheet and js for side bars -->
  <script>
    const tmpl = document.getElementById('sidebar-template');
    
    class MySidebar extends HTMLElement {
      constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });
    
        // inject CSS, stamp template…
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/static/css/index.css';
        shadow.appendChild(link);
        
        // 2) inject Bootstrap into the shadow as well
        const bs = document.createElement('link');
        bs.rel       = 'stylesheet';
        bs.href      = 'https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css';
        bs.integrity = 'sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC';
        bs.crossOrigin = 'anonymous';
        shadow.appendChild(bs);
    
        // 2) stamp in the template
        shadow.appendChild(tmpl.content.cloneNode(true));

        // grab the parts we need
        // grab your button and sidebar host
        this.toggleBtn  = shadow.getElementById('toggle-btn');
        this.sidebarEl = shadow.querySelector('.sidebar');
        
      }
    
      connectedCallback() {
        // main toggle
        this.toggleBtn.addEventListener('click', () => this.toggleSidebar());

    
        // submenu toggles
        this.shadowRoot.querySelectorAll('.dropdown-btn')
          .forEach(btn =>
            btn.addEventListener('click', () => this.toggleSubMenu(btn))
          );
      }
    
      toggleSidebar() {
        this.sidebarEl.classList.toggle('close');
        this.toggleBtn.classList.toggle('rotate');
        this.closeAllSubMenus();
      }
    
      toggleSubMenu(button) {
        //console.log("true")
        const submenu = button.nextElementSibling;
        if (!submenu.classList.contains('show')) {
          this.closeAllSubMenus();
        }
        submenu.classList.toggle('show');
        button.classList.toggle('rotate');
    
        if (this.classList.contains('close')) {
          this.toggleSidebar();  // reopen if it was closed
        }
      }
    
      closeAllSubMenus() {
        this.shadowRoot.querySelectorAll('.submenu.show').forEach(ul => {
          ul.classList.remove('show');
          ul.previousElementSibling.classList.remove('rotate');
        });
      }
    }
    
    customElements.define('my-sidebar', MySidebar);
    
  </script>

</body>
</html>