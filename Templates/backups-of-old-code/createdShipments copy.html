<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="/static/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/static/img/favicon.png">
  <title>
    RFT System</title>
  <link rel="stylesheet" href="/static/css/index.css">
  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
  <link href="/static/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/static/css/nucleo-svg.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" crossorigin="anonymous"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link id="pagestyle" href="/static/css/material-dashboard.css?v=3.1.0" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>

<style>
/*  */
  /* Use this class on your shipment number element, e.g. <span class="shipment-clickable">#12345</span> */

  .shipment-clickable {
    display: inline-block;
    color: #007bff;          /* base link-blue color */
    text-decoration: none;
    position: relative;
    transition: color 0.2s ease, transform 0.2s ease;
    cursor: pointer;
  }

  .shipment-clickable::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: -2px;
    width: 100%;
    height: 2px;
    background: #007bff;
    transform: scaleX(0);
    transform-origin: left center;
    transition: transform 0.2s ease;
  }

  .shipment-clickable:hover {
    color: #0056b3;          /* darker blue on hover */
    transform: translateY(-2px);
  }

  .shipment-clickable:hover::after {
    transform: scaleX(1);
  }

  .shipment-clickable:active {
    color: #003f7f;
    transform: translateY(0);
  }

/*  */
    input[type="file"] {
    position: relative;
  }

  input[type="file"]::file-selector-button {
    width: 136px;
    color: transparent;
  }

  /* Faked label styles and icon */
  input[type="file"]::before {
    position: absolute;
    pointer-events: none;
    top: 10px;
    left: 16px;
    height: 20px;
    width: 20px;
    content: "";
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%230964B0'%3E%3Cpath d='M18 15v3H6v-3H4v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2zM7 9l1.41 1.41L11 7.83V16h2V7.83l2.59 2.58L17 9l-5-5-5 5z'/%3E%3C/svg%3E");

  }

  input[type="file"]::after {
    position: absolute;
    pointer-events: none;
    top: 11px;
    left: 40px;
    color: #0964b0;
    content: "Upload File";
  }

  /* ------- From Step 1 ------- */

  /* file upload button */
  input[type="file"]::file-selector-button {
    border-radius: 4px;
    padding: 0 16px;
    height: 40px;
    cursor: pointer;
    background-color: white;
    border: 1px solid rgba(0, 0, 0, 0.16);
    box-shadow: 0px 1px 0px rgba(0, 0, 0, 0.05);
    margin-right: 16px;
    transition: background-color 200ms;
  }

  /* file upload button hover state */
  input[type="file"]::file-selector-button:hover {
    background-color: #f3f4f6;
  }

  /* file upload button active state */
  input[type="file"]::file-selector-button:active {
    background-color: #e5e7eb;
  }
            /* end of file upload button styling */
  /* ------------------------ */

  .tooltip {
      z-index: 999999; /* Higher than default Bootstrap elements */
  }

  .po-cell {
      max-width: calc(8ch + 4px); /* Adjust for padding/margins or slight variations */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      display: inline-block; /* Ensures consistent behavior for text-overflow */
  }

  .po-cell.expanded {
      max-width: none; /* Show full content when expanded */
      white-space: normal; /* Allow multi-line text if needed */
  }

  .bg-gradient-primary {
    background-image: linear-gradient(195deg, #4054ec 0%, #D81B60 100%);
  }
  .dropdown-container {
    display: block;
    padding-left: 8px;
  }
  ::-webkit-scrollbar {
    display: none;
  }
  .dropdown-btn {
    padding: 6px 8px 6px 16px;
    text-decoration: none;
    font-size: 20px;
    color: #818181;
    display: block;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    outline: none;
  }
  .hov:hover {
    display: flex;
    width: 169px;
    border: none;
    border-radius: 5px;
    background-image: linear-gradient(195deg, #4054ec 0%, #D81B60 100%);
  }
  .numbadge {
    --bs-badge-padding-x: 0.5em;
    --bs-badge-padding-y: 0.5em;
    --bs-badge-font-size: 0.75em;
    --bs-badge-font-weight: 700;
    --bs-badge-color: #fff;
    --bs-badge-border-radius: 10rem;
    display: inline-block;
    padding: var(--bs-badge-padding-y) var(--bs-badge-padding-x);
    font-size: var(--bs-badge-font-size);
    font-weight: var(--bs-badge-font-weight);
    line-height: 1;
    color: var(--bs-badge-color);
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: var(--bs-badge-border-radius);
  }
  .border2 {
    border: 2px solid #000 !important;
  }
  .input-custom {
    background-color: #f8f9fa;
    border: none;
    border-bottom: 2px solid #ced4da;
    padding: 10px;
    border-radius: 0;
    outline: none;
  }

  .input-custom:focus {
    background-color: #f8f9fa;
    border-bottom: 2px solid #4054ec;
    box-shadow: none;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    font-weight: bold;
  }

  .btn-primary {
    background-color: #4054ec;
    border-color: #4054ec;
  }

  .btn-primary:hover {
    background-color: #3547d3;
    border-color: #3547d3;
  }
  .instructions {
      /* font-size: 5px; */
      color: #51d94f; /* Bootstrap danger color */
      background-color: #fbfe12; /* Bootstrap danger background */
      border: 1px solid #ebccd1; /* Bootstrap danger border */
      padding: 5px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: 500;
  }
  .filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
    padding-left: 19px;
  }

  .filter-container select,
  .filter-container input {
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
</style>

<body class="g-sidenav-show bg-gray-200">
  <!-- SERCHABLE DROPDOWNS -->
  <!-- Include jQuery and Select2 JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script>
      $(document).ready(function () {
          $("#brandFilter ").select2({
              multiple: true,
              allow_clear:true,
          });
      });
  </script>
  {% include 'sidebar2.html' %}  
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Home</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Freights</li>
          </ol>
            <h6 class="font-weight-bolder mb-0">Create Shipments</h6>
        </nav>
        <ul class="navbar-nav justify-content-end">
          <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
            <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
              <div class="sidenav-toggler-inner">
                <i class="sidenav-toggler-line"></i>
                <i class="sidenav-toggler-line"></i>
                <i class="sidenav-toggler-line"></i>
              </div>
            </a>
          </li>
          <li>
            <img id="robote" src="static/img/robot.gif" style="position: absolute; z-index: 9; right: 500px; display: none;">
          </li>
          <li class="nav-item d-flex align-items-center">
            <a href="#" class="nav-link text-body font-weight-bold px-0">
              <i class="fa fa-user me-sm-1" style="font-size: 1.275rem;"></i>
              <span class="d-sm-inline d-none" style="font-size: 1.275rem;">{{session['username']}}</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card my-4">
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
              <div class="bg-gradient-dark shadow-primary border-radius-lg pt-4 pb-3">
                <h6 class="btn-outline-primary bg-gradient-primary text-white text-capitalize ps-3" style="width: 200px; cursor: pointer; border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
                  Created Shipments
                </h6>
              </div>
            </div>
            <div class="card-body px-0 pb-0" style="padding: 2px;">
              {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                  {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" style="color: white;">
                      {{ message }}
                      <button type="button" class="btn-close" style="color: white;" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                  {% endfor %}
                {% endif %}
              {% endwith %}
              <div class="filter-container " style="z-index: 1;background-color: #f5f5f5; border: 1px solid #ddd !important;
                padding: 10px;
                margin: 5px;
                /* margin-bottom: 10px; */
                ">
                <!-- Brand Name Filter -->
                <!-- onchange="filterTable('brandFilter', 1)" -->
                <select id="brandFilter" onchange="filterTable('brandFilter', 1)" multiple>
                  <option value="" selected disabled>Brand Name</option>
                  {% for brand in brand_names2 %}
                  <option value="{{brand}}">{{brand}}</option>
                  {% endfor %}
                </select>

                <!-- siteFilter Filter -->
                <select id="siteFilter" onchange="filterTable('siteFilter', 0)">
                  <option value="" selected disabled>Filter By Site</option>
                  {% for site in sites2 %}
                  <option value="{{site}}">{{site}}</option>
                  {% endfor %}
                </select>

                <!-- User selected types Filter -->
                <select id="deliverystatusFilter" onchange="filterTable('deliverystatusFilter', 1)">
                  <option value="" selected disabled>Filter by Delivery Status</option>
                  {% for status in status_list %}
                  <option value="{{ status }}" >{{ status }}</option>
                  {% endfor %}
                </select>
                
                <!-- Customer Name Filter -->
                <input id="customerFilter" placeholder="Filter Customer Name" oninput="filterTable('customerFilter', 2)" />
                
                <!-- Delivery Note Filter (Number Input) -->
                <input type="number" id="deliveryFilter" oninput="filterTable('deliveryFilter', 4)" placeholder="Filter by Delivery Note" />

                <!-- SO Filter (Number Input) -->
                <input type="number" id="soFilter" oninput="filterTable('soFilter', 3)" placeholder="Filter by Sales Document" />

                <!-- Billing DOC Filter (Number Input) -->
                <input type="number" id="billingFilter" oninput="filterTable('billingFilter', 5)" placeholder="Filter by Billing Document" />

                <!-- NET VAL Filter (Number Input) -->
                <input type="number" id="netvalFilter" oninput="filterTable('netvalFilter', 6)" placeholder="Filter by NetValue" />

                <!-- NET VAL Filter (Number Input) -->
                <input type="month" id="createdOnFilter" oninput="filterTable('createdOnFilter', 6)" placeholder="Created Month e.g Jan,FEB" />

                <!-- Submit/ serch btuuton for filter (search in db) -->
                <button id="submit" type="submit" style="width: 600px;" form="main_form" class="badge badge-sm bg-gradient-info {{ 'd-none' if brand_wise else ''}} ">Submit New Statues</button>

              </div>
              <form id="main_form" action="{{ url_for('main.createdShipments') }}" method="POST">
                <div class="table-responsive p-0">
                  <table class="table  mb-0 table-responsive ">
                    <thead>
                      <tr>
                        <!-- <th>Sr.<input style="width: 30% !important;" type="checkbox" id="select-all"></th> -->
                        <!-- <th>POID</th> -->
                        <th>Shipment #</th>
                        <th>Shipment Status</th>
                        <th>Payment Status</th>
                        <th>Biyan Number</th>
                        <th>Biyan PDF</th>
                        <th>SADDAD Number</th>
                        <th>SADDAD PDF</th>
                        
                        <th>Actions</th>
                        <!-- <th>Actions</th> -->
                      </tr>
                    </thead>
                    <tbody >
                      {% for row in report_data %}
                      {# {% if (row.Brand in session['user_brand_access']) or (row.Site in session['user_site_access']) %} #}
                        <tr>
                          <!-- <td >{{ loop.index }}. <input type="checkbox" name="id" id="" class="item-checkbox" value="{{ row.POID }}"></td> -->
                          <!-- <td>{{ row.POID }}</td> -->
                          <td class="align-middle">
                            <input type="hidden" name="ShipmentNumber_{{ row.ShipmentNumber }}" value="{{ row.ShipmentNumber }}"/>
                            <a class="shipment-clickable" href="{{ url_for('main.updateShipments', shipment_id=row.ShipmentID) }}">{{ row.ShipmentNumber }}</a>
                          </td>
                          <td class="align-middle">
                            <select name="Status_{{ row.ShipmentNumber }}" id="ShipmentStatus" onchange="trackChange(this, '{{ row.ShipmentNumber }}')">
                              {% for status in shipmentstatuses %}
                              <option value="{{status.StatusName}}" {{ 'selected' if row.ShipmentLevelStatus == status.StatusName else '' }} >{{status.StatusName}}</option>
                              {% endfor %}
                            </select>
                          </td>
                          <td class="align-middle text-center text-sm">
                            <span class="badge badge-sm {%if row.SADDADNumber and row.BiyanNumber%} bg-gradient-success {% endif %} {%if not row.SADDADNumber or not row.BiyanNumber%} bg-gradient-danger {% endif %}">{%if not row.SADDADNumber and not row.BiyanNumber %}Pending Payments{% endif %}{%if row.SADDADNumber and not row.BiyanNumber %} Pending Biyan {% endif %} {%if row.BiyanNumber and not row.SADDADNumber%}Pending SADDAD {% endif %} {%if row.BiyanNumber and row.SADDADNumber%}Biyan & SADDAD Paid {% endif %}</span>
                          </td>
                          <td class="align-middle"><input name="BiyanNumber_{{ row.ShipmentNumber }}" type="text" value="{{ row.BiyanNumber if row.BiyanNumber else '' }}" oninput="trackChange(this, '{{ row.ShipmentNumber }}')"/></td>
                          <td class="align-middle">
                            <input name="biyanPDF_file_{{ row.ShipmentNumber }}" type="file" accept="application/pdf" oninput="trackChange(this, '{{ row.ShipmentNumber }}')" />
                            {% set biyan_filename = row.ShipmentNumber ~ '_biyan.pdf' %}
                            {% if biyan_filename in existing_biyan_files %}
                              <a href="{{ url_for('static', filename='Biyan-files/' ~ biyan_filename) }}" target="_blank" class="d-block mt-1 text-primary" style="width: fit-content;">
                                View Uploaded Biyan
                              </a>
                            {% endif %}
                          </td>
                          <td class="align-middle"><input name="SADDADNumber_{{ row.ShipmentNumber }}" type="text" value="{{ row.SADDADNumber or '' }}" oninput="trackChange(this, '{{ row.ShipmentNumber }}')" /></td>
                          <td class="align-middle">
                            <input name="saddadPDF_file_{{ row.ShipmentNumber }}" type="file" accept="application/pdf" oninput="trackChange(this, '{{ row.ShipmentNumber }}')" />
                            {% set saddad_filename = row.ShipmentNumber ~ '_saddad.pdf' %}
                            {% if saddad_filename in existing_saddad_files %}
                              <a href="{{ url_for('static', filename='SADDAD-files/' ~ saddad_filename) }}" target="_blank" class="d-block mt-1 text-primary" style="width: fit-content;">
                                View Uploaded SADDAD
                              </a>
                            {% endif %}
                          </td>
                        
                          <!-- DELEET BUTTON -->
                          {% if session['role'] == 'admin' %}
                          <td class="align-middle">
                            <a class="cursor-pointer" href="/archive_order?order_id={{ row.ID }}">
                              <i class="material-icons opacity-10" style="color: red;">delete</i>
                            </a>
                          </td>
                          {# {% endif %} #}
                        </tr>
                        {% endif %}
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% include 'footer_credits.html' %}
    </div>
  </main>
  <div class="fixed-plugin">
    <div class="card shadow-lg">
      <div class="card-header pb-0 pt-3">
        <div class="float-start">
          <h5 class="mt-3 mb-0"></h5>
          <p></p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="material-icons">clear</i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
    </div>
  </div>
  <!-- Core JS Files -->
  <script src="/static/js/core/popper.min.js"></script>
  <script src="/static/js/core/bootstrap.min.js"></script>
  <script src="/static/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="/static/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="/static/js/generalScripts.js"></script>
  <script src="/static/js/clockAndReminder.js"></script>
  

  <script>
    let changedElements = {};

    // Function to track changes in select elements
    function trackChange(element, recordId) {
      const name = element.name;
      const value = element.value;

      changedElements[name] = value;

      // Also include the POID to ensure it's submitted
      changedElements[`ShipmentNumber_${recordId}`] = recordId;
    }

    document.getElementById('main_form').addEventListener('submit', function(event) {
      event.preventDefault(); // Stop default form submit

      const originalForm = document.getElementById('main_form');
      const formData = new FormData();

      // Add only changed inputs
      for (let name in changedElements) {
        const input = originalForm.elements[name];
        if (input && input.type === 'file') {
          if (input.files.length > 0) {
            formData.append(name, input.files[0]);
          }
        } else {
          formData.append(name, changedElements[name]);
        }
      }

      // Send it via POST
      fetch('{{ url_for("main.createdShipments") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.redirect) {
          window.location.href = data.redirect;  // causes a real redirect → flash will show
        }
      })
      .catch(error => {
        console.error('Upload failed', error);
      });
    });

  </script>

  <script>
    function expandCell(cell) {
        cell.classList.toggle("expanded");
    }
    // Ensure DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // For tooltips
      $('[data-toggle="tooltip"]').tooltip();
    })
  </script>
  
  <script>
    var columnMapping =  column_mapping | tojson |safe;
    // function filterTable() {
    //   var table = document.querySelector(".table-responsive .table");
    //   var tr = table.getElementsByTagName("tr");

    //   // Get selected brands as an array (or empty if none selected)
    //   var selectedBrands = $('#brandFilter').val() || [];
    //   // Convert to uppercase for case-insensitive comparison
    //   var uppercaseSelectedBrands = selectedBrands.map(function(b) {
    //     return b.trim().toUpperCase();
    //   });

    //   var filter_customer = document.getElementById('customerFilter').value.toUpperCase();
    //   var filter_so = document.getElementById('soFilter').value.toUpperCase();
    //   var filter_site = document.getElementById('siteFilter').value.toUpperCase();
    //   var filter_delivery = document.getElementById('deliveryFilter').value.toUpperCase();
    //   var filter_billing = document.getElementById('billingFilter').value.toUpperCase();
    //   var filter_netval = document.getElementById('netvalFilter').value.toUpperCase();
    //   var filter_status = document.getElementById('deliverystatusFilter').value.toUpperCase();
    //   var filter_createdOnFilter = document.getElementById('createdOnFilter').value.toUpperCase();

    //   // Loop through all table rows (except the first with headers)
    //   for (var i = 1; i < tr.length; i++) {
    //     var td_site = tr[i].getElementsByTagName("td")[2];    // Site
    //     var td_brand = tr[i].getElementsByTagName("td")[3];   // Brand
    //     var td_customer = tr[i].getElementsByTagName("td")[4];// Customer
    //     var td_so = tr[i].getElementsByTagName("td")[6];      // SO
    //     var td_delivery = tr[i].getElementsByTagName("td")[7];// Delivery
    //     var td_billing = tr[i].getElementsByTagName("td")[8]; // Billing
    //     var td_netval = tr[i].getElementsByTagName("td")[9];  // Net Value
    //     var td_status = tr[i].getElementsByTagName("td")[11];  // Delivery Status
    //     var td_createdOn = tr[i].getElementsByTagName("td")[13]; // Created On

    //     if (td_brand && td_customer && td_so && td_site && td_delivery && td_billing && td_netval && td_status && td_createdOn) {
    //       var brandValue = (td_brand.textContent || td_brand.innerText).trim();
    //       var customerValue = (td_customer.textContent || td_customer.innerText).trim();
    //       var soValue = (td_so.textContent || td_so.innerText).trim();
    //       var siteValue = (td_site.textContent || td_site.innerText).trim();
    //       var deliveryValue = (td_delivery.textContent || td_delivery.innerText).trim();
    //       var billingValue = (td_billing.textContent || td_billing.innerText).trim();
    //       var netvalValue = (td_netval.textContent || td_netval.innerText).trim();
    //       var statusValue = (td_status.textContent || td_status.innerText).trim().toUpperCase();
    //       var createdOnValue = (td_createdOn.textContent || td_createdOn.innerText).trim();

    //       // Check brand match
    //       var brandMatch = (uppercaseSelectedBrands.length === 0) ||
    //         uppercaseSelectedBrands.some(function(b) {
    //           return brandValue.toUpperCase().indexOf(b) > -1;
    //         });

    //       // Other filters
    //       var customerMatch = (customerValue.toUpperCase().indexOf(filter_customer) > -1 || !filter_customer);
    //       var soMatch = (soValue.toUpperCase().indexOf(filter_so) > -1 || !filter_so);
    //       var siteMatch = (siteValue.toUpperCase().indexOf(filter_site) > -1 || !filter_site);
    //       var deliveryMatch = (deliveryValue.toUpperCase().indexOf(filter_delivery) > -1 || !filter_delivery);
    //       var billingMatch = (billingValue.toUpperCase().indexOf(filter_billing) > -1 || !filter_billing);
    //       var netvalMatch = (netvalValue.toUpperCase().indexOf(filter_netval) > -1 || !filter_netval);
    //       var createdOnMatch = (createdOnValue.toUpperCase().indexOf(filter_createdOnFilter) > -1 || !filter_createdOnFilter);
    //       var statusMatch = (statusValue === filter_status || !filter_status);

    //       // Now incorporate brandMatch into the final condition
    //       if (
    //         brandMatch &&
    //         customerMatch &&
    //         soMatch &&
    //         siteMatch &&
    //         deliveryMatch &&
    //         billingMatch &&
    //         netvalMatch &&
    //         createdOnMatch &&
    //         statusMatch
    //       ) {
    //         tr[i].style.display = ""; // Show row
    //       } else {
    //         tr[i].style.display = "none"; // Hide row
    //       }
    //     }
    //   }
    // }

    function filterTable() {
      // Grab the table and its rows
      var table = document.querySelector(".table-responsive .table");
      var tr = table.getElementsByTagName("tr");

      // Create an object to store filter values.
      // For multi-select filters like "brandFilter", we store an array.
      var filterValues = {};

      // Process multi-select filter: 'brandFilter'
      var brandElem = document.getElementById("brandFilter");
      if (brandElem) {
        // Using jQuery for multi-select (adjust if necessary)
        var selectedBrands = $(brandElem).val() || [];
        // Normalize all selected brands to uppercase for case-insensitive matching
        filterValues["brandFilter"] = selectedBrands.map(function(b) {
          return b.trim().toUpperCase();
        });
      }

      // Process all other filter inputs defined in the mapping
      Object.keys(columnMapping).forEach(function(filterId) {
        // Skip the multi-select which we already processed
        if (filterId === "brandFilter") return;
        var elem = document.getElementById(filterId);
        if (elem) {
          // Normalize the input value to uppercase for case-insensitive matching
          filterValues[filterId] = elem.value.toUpperCase();
        }
      });

      // Loop through all table rows (assuming the first row is headers)
      for (var i = 1; i < tr.length; i++) {
        var row = tr[i];
        var tds = row.getElementsByTagName("td");
        var rowVisible = true;

        // Loop over each filter. Use the mapping to fetch the appropriate cell.
        for (var filterId in filterValues) {
          var filterValue = filterValues[filterId];

          // Get the corresponding column index from our mapping
          var colIndex = columnMapping[filterId];
          var cell = tds[colIndex];

          if (cell) {
            var cellText = (cell.textContent || cell.innerText).trim().toUpperCase();

            if (filterId === "brandFilter") {
              // For multi-select: if any of the selected brands appear in the cell, it passes.
              if (filterValue.length > 0) {
                var matchFound = filterValue.some(function(val) {
                  return cellText.indexOf(val) > -1;
                });
                if (!matchFound) {
                  rowVisible = false;
                  break;
                }
              }
            } else if (filterId === "deliverystatusFilter") {
              // For status, you might want an exact match. Adjust as needed.
              if (filterValue && cellText !== filterValue) {
                rowVisible = false;
                break;
              }
            } else {
              // For all other filters, check if the cell text contains the filter value.
              if (filterValue && cellText.indexOf(filterValue) === -1) {
                rowVisible = false;
                break;
              }
            }
          }
        }
        // Show or hide the row based on whether all filters were met
        row.style.display = rowVisible ? "" : "none";
      }
    }

    // Register event listeners for all filter inputs using the generic mapping
    Object.keys(columnMapping).forEach(function(filterId) {
      var elem = document.getElementById(filterId);
      if (elem) {
        // Use both 'input' and 'change' events to cover text fields and select elements
        elem.addEventListener('input', filterTable);
        elem.addEventListener('change', filterTable);
      }
    });

    function sortTableWithToggle(element, columnIndex) {
        const table = document.querySelector(".table-responsive .table");
        const rows = Array.from(table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"));

        // Determine the sort order based on the current arrow class
        const isDescending = element.classList.contains("fa-caret-down");
        const newOrder = isDescending ? "asc" : "desc";

        // Toggle the arrow class for the clicked column only
        const allArrows = document.querySelectorAll(".sort-arrow-SA, .sort-arrow-OR");
        allArrows.forEach(arrow => {
            if (arrow !== element) {
                arrow.classList.remove("fa-caret-up", "fa-caret-down");
                arrow.classList.add("fa-caret-down"); // Reset other arrows to down
            }
        });

        element.classList.toggle("fa-caret-down", !isDescending);
        element.classList.toggle("fa-caret-up", isDescending);

        // Sort only visible rows
        const visibleRows = rows.filter(row => row.style.display !== "none");

        visibleRows.sort((a, b) => {
            const aValue = parseInt(a.getElementsByTagName("td")[columnIndex].innerText.trim()) || 0;
            const bValue = parseInt(b.getElementsByTagName("td")[columnIndex].innerText.trim()) || 0;

            return newOrder === "desc" ? bValue - aValue : aValue - bValue;
        });

        // Reattach sorted rows
        visibleRows.forEach(row => table.getElementsByTagName("tbody")[0].appendChild(row));
    }

    // Add event listeners
    // For multi-select, 'change' is the appropriate event
    document.getElementById('brandFilter').addEventListener('change', filterTable);
    document.getElementById('customerFilter').addEventListener('input', filterTable);
    document.getElementById('soFilter').addEventListener('input', filterTable);
    document.getElementById('siteFilter').addEventListener('input', filterTable);
    document.getElementById('deliveryFilter').addEventListener('input', filterTable);
    document.getElementById('billingFilter').addEventListener('input', filterTable);
    document.getElementById('netvalFilter').addEventListener('input', filterTable);
    document.getElementById('deliverystatusFilter').addEventListener('input', filterTable);
    document.getElementById('createdOnFilter').addEventListener('input', filterTable);
  </script>
</body>
</html>
